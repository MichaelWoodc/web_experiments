<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Squares Experiment</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: black;
            color: white;
            text-align: center;
            margin: 0;
            padding: 0;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        #instructions {
            max-width: 80%;
            margin: 20px auto;
            font-size: 24px;
            line-height: 1.5;
            text-shadow: 
                -1px -1px 0 #000,
                1px -1px 0 #000,
                -1px 1px 0 #000,
                1px 1px 0 #000;
        }
        
        #mainSquare {
            width: 250px;
            height: 250px;
            background-color: white;
            margin: 20px auto;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        #pointsSquare {
            width: 100px;
            height: 100px;
            background-color: white;
            position: absolute;
            right: 100px;
            bottom: 100px;
            cursor: pointer;
            display: none;
        }
        
        #scoreDisplay {
            position: absolute;
            left: 50px;
            top: 50px;
            font-size: 48px;
            text-shadow: 
                -1px -1px 0 #000,
                1px -1px 0 #000,
                -1px 1px 0 #000,
                1px 1px 0 #000;
        }
        
        #infoText {
            font-size: 20px;
            margin: 20px auto;
            max-width: 80%;
            text-shadow: 
                -1px -1px 0 #000,
                1px -1px 0 #000,
                -1px 1px 0 #000,
                1px 1px 0 #000;
        }
        
        #consentForm {
            background-color: #333;
            padding: 20px;
            border-radius: 10px;
            max-width: 600px;
            margin: 50px auto;
            text-align: left;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: white;
            text-shadow: 
                -1px -1px 0 #000,
                1px -1px 0 #000,
                -1px 1px 0 #000,
                1px 1px 0 #000;
        }
        
        select, input[type="text"] {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            text-shadow: 
                -1px -1px 0 #000,
                1px -1px 0 #000,
                -1px 1px 0 #000,
                1px 1px 0 #000;
        }
        
        button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="consentForm">
            <h2>Experiment Consent Form</h2>
            <div class="form-group">
                <label for="participantID">Participant ID:</label>
                <input type="text" id="participantID" value="000001" readonly>
            </div>
            <div class="form-group">
                <label for="gender">Gender:</label>
                <select id="gender">
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Non-binary">Non-binary</option>
                    <option value="Prefer not to say">Prefer not to say</option>
                </select>
            </div>
            <div class="form-group">
                <label for="age">Age:</label>
                <select id="age">
                    <option value="18">18</option>
                    <option value="19">19</option>
                    <option value="20">20</option>
                    <option value="21">21</option>
                    <option value="22">22</option>
                    <option value="23">23</option>
                    <option value="24">24</option>
                    <option value="26+">26+</option>
                </select>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="consentCheckbox"> I consent to participate in this experiment*
                </label>
            </div>
            <button id="startExperiment">Start Experiment</button>
        </div>
        
        <div id="instructions" style="display: none;"></div>
        <div id="mainSquare" style="display: none;"></div>
        <div id="pointsSquare"></div>
        <div id="scoreDisplay" style="display: none;">0</div>
        <div id="infoText" style="display: none;"></div>
        <div id="pointsInstructions" style="display: none;"></div>
    </div>

    <script>
        // Fixed component order
        const componentOrder = [1, 2, 1, 2, 3, 4, 3, 4];

        // Component definitions with text color and points square instructions
        const components = {
            1: {
                random_min_time: 1,
                random_max_time: 8,
                end_phase_at_time: 120,
                points_per_click: 1,
                background: "green",
                text_color: "white",
                instructions_text: "Phase 1 Instructions",
                points_instructions: "Click the small square fast to earn points!"
            },
            2: {
                random_min_time: 1,
                random_max_time: 5,
                end_phase_at_time: 120,
                points_per_click: 1,
                background: "yellow",
                text_color: "black",
                instructions_text: "Phase 2 Instructions",
                points_instructions: ""
            },
            3: {
                random_min_time: 5,
                random_max_time: 10,
                end_phase_at_time: 120,
                points_per_click: 1,
                background: "red",
                text_color: "white",
                instructions_text: "Phase 3 Instructions",
                points_instructions: "Click quickly for points!"
            },
            4: {
                random_min_time: 10,
                random_max_time: 20,
                end_phase_at_time: 120,
                points_per_click: 0,
                background: "yellow",
                text_color: "black",
                instructions_text: "Phase 4 Instructions",
                points_instructions: ""
            }
        };

        // Experiment variables
        let score = 0;
        let currentComponent = null;
        let currentInterval = 0;
        let pointsSquareTimeout = null;
        let experimentStartTime = 0;
        let phaseStartTime = 0;
        let currentComponentIndex = 0;
        let lastValidClickTime = 0;
        let squareAppearTime = 0;
        let phaseTimer = null;
        
        // DOM elements
        const consentForm = document.getElementById('consentForm');
        const instructions = document.getElementById('instructions');
        const mainSquare = document.getElementById('mainSquare');
        const pointsSquare = document.getElementById('pointsSquare');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const infoText = document.getElementById('infoText');
        const pointsInstructions = document.getElementById('pointsInstructions');
        const startButton = document.getElementById('startExperiment');
        const container = document.getElementById('container');
        
        // Experiment data
        let experimentData = {
            participant: '',
            gender: '',
            age: '',
            componentOrder: [...componentOrder],
            phases: [],
            clicks: [],
            finalScore: 0
        };
        
        // Generate a new random interval for current component
        function getNewInterval() {
            const comp = currentComponent;
            const newInterval = Math.floor(
                Math.random() * (comp.random_max_time - comp.random_min_time + 1)
            ) + comp.random_min_time;
            
            console.log('New interval set to:', newInterval, 'seconds');
            return newInterval;
        }
        
        // Hide points square and show main square
        function returnToMainSquare() {
            clearTimeout(pointsSquareTimeout);
            pointsSquare.style.display = 'none';
            pointsSquare.onclick = null;
            pointsInstructions.style.display = 'none';
            mainSquare.style.display = 'block';
            scoreDisplay.style.display = 'block';
            
            // Set text color for this component
            document.querySelectorAll('#instructions, #infoText, #scoreDisplay, #pointsInstructions').forEach(el => {
                el.style.color = currentComponent.text_color;
            });
            
            // Track when square appears for interval timing
            squareAppearTime = Date.now();
            currentInterval = getNewInterval();
            
            // Update info text if component has instructions
            if (currentComponent.instructions_text) {
                infoText.style.display = 'block';
                infoText.textContent = currentComponent.instructions_text;
            } else {
                infoText.style.display = 'none';
            }
        }
        
        // Transition between components (3 second black screen)
        function transitionToNextComponent() {
            // Clear any existing timers
            clearTimeout(pointsSquareTimeout);
            clearTimeout(phaseTimer);
            
            // Hide everything
            mainSquare.style.display = 'none';
            pointsSquare.style.display = 'none';
            scoreDisplay.style.display = 'none';
            infoText.style.display = 'none';
            pointsInstructions.style.display = 'none';
            container.style.backgroundColor = 'black';
            
            // Reset text to default white
            document.querySelectorAll('#instructions, #infoText, #scoreDisplay, #pointsInstructions').forEach(el => {
                el.style.color = 'white';
            });
            
            // Check if there are more components
            if (currentComponentIndex < componentOrder.length) {
                setTimeout(startComponent, 3000);
            } else {
                endExperiment();
            }
        }
        
        // Start a new component
        function startComponent() {
            currentComponent = components[componentOrder[currentComponentIndex]];
            currentComponentIndex++;
            
            // Reset timing for new component
            lastValidClickTime = 0;
            squareAppearTime = Date.now();
            currentInterval = getNewInterval();
            
            // Record phase start
            phaseStartTime = Date.now();
            experimentData.phases.push({
                component: componentOrder[currentComponentIndex - 1],
                startTime: (phaseStartTime - experimentStartTime) / 1000,
                settings: {...currentComponent}
            });
            
            // Set phase timer to end at correct time
            phaseTimer = setTimeout(() => {
                transitionToNextComponent();
            }, currentComponent.end_phase_at_time * 1000);
            
            // Set background and text color
            container.style.backgroundColor = currentComponent.background;
            document.querySelectorAll('#instructions, #infoText, #scoreDisplay, #pointsInstructions').forEach(el => {
                el.style.color = currentComponent.text_color;
            });
            
            // Initialize component
            mainSquare.style.display = 'block';
            scoreDisplay.style.display = 'block';
            
            // Set info text if component has instructions
            if (currentComponent.instructions_text) {
                infoText.style.display = 'block';
                infoText.textContent = currentComponent.instructions_text;
            }
        }
        
        // Main square click handler
        function handleMainSquareClick() {
            const currentTime = Date.now();
            const timeSinceSquareAppeared = (currentTime - squareAppearTime) / 1000;
            
            // Only accept click if enough time has passed since square appeared
            if (timeSinceSquareAppeared >= currentInterval) {
                // Valid click - process it
                lastValidClickTime = currentTime;
                
                // Show points square
                mainSquare.style.display = 'none';
                pointsSquare.style.display = 'block';
                
                // Show points instructions if they exist
                if (currentComponent.points_instructions) {
                    pointsInstructions.style.display = 'block';
                    pointsInstructions.textContent = currentComponent.points_instructions;
                } else {
                    pointsInstructions.style.display = 'none';
                }
                
                // Record the click
                experimentData.clicks.push({
                    type: 'mainSquare',
                    time: (currentTime - experimentStartTime) / 1000,
                    score: score,
                    interval: currentInterval,
                    component: componentOrder[currentComponentIndex - 1]
                });
                
                // Set timeout to hide points square after 3 seconds
                pointsSquareTimeout = setTimeout(() => {
                    returnToMainSquare();
                }, 3000);
                
                // Points square click handler
                pointsSquare.onclick = function() {
                    score += currentComponent.points_per_click;
                    scoreDisplay.textContent = score;
                    
                    // Record the click
                    experimentData.clicks.push({
                        type: 'pointsSquare',
                        time: (Date.now() - experimentStartTime) / 1000,
                        score: score,
                        component: componentOrder[currentComponentIndex - 1]
                    });
                    
                    // Immediately hide points square when clicked
                    clearTimeout(pointsSquareTimeout);
                    returnToMainSquare();
                };
            } else {
                const waitTime = (currentInterval - timeSinceSquareAppeared).toFixed(1);
                console.log(`Too soon! Wait ${waitTime} more seconds`);
                
                // Visual feedback
                mainSquare.style.backgroundColor = 'red';
                setTimeout(() => {
                    mainSquare.style.backgroundColor = 'white';
                }, 300);
            }
        }

        // Start experiment when button is clicked
        startButton.addEventListener('click', function() {
            if (!document.getElementById('consentCheckbox').checked) {
                alert('You must consent to participate in the experiment');
                return;
            }
            
            // Record participant info
            experimentData.participant = document.getElementById('participantID').value;
            experimentData.gender = document.getElementById('gender').value;
            experimentData.age = document.getElementById('age').value;
            
            // Hide consent form and show instructions
            consentForm.style.display = 'none';
            instructions.style.display = 'block';
            instructions.innerHTML = `
                <h2>Instructions</h2>
                <p>Only click the big white square one time every 15 seconds. Just wait 15 seconds between clicking it.</p>
                <p>When the other square comes up, click on it fast until it disappears.</p>
                <p>Press any key to begin.</p>
            `;
            
            // Start the experiment after any key press
            document.addEventListener('keydown', function startHandler() {
                document.removeEventListener('keydown', startHandler);
                instructions.style.display = 'none';
                
                // Set up main square click handler
                mainSquare.onclick = handleMainSquareClick;
                
                // Start experiment
                experimentStartTime = Date.now();
                startComponent();
            }, {once: true});
        });
        
        // End experiment function
        function endExperiment() {
            // Remove event listeners
            mainSquare.onclick = null;
            pointsSquare.onclick = null;
            
            // Hide experiment elements
            mainSquare.style.display = 'none';
            pointsSquare.style.display = 'none';
            scoreDisplay.style.display = 'none';
            pointsInstructions.style.display = 'none';
            
            // Show completion message
            infoText.style.display = 'block';
            infoText.innerHTML = `
                <h1>Experiment Complete</h1>
                <p>Your final score: ${score}</p>
                <p>Thank you for participating!</p>
                <div id="saveStatus">Preparing data...</div>
            `;
            
            // Save final score
            experimentData.finalScore = score;
            
            // Save data to server
            saveDataToServer();
        }

        function saveDataToServer() {
            const saveStatus = document.getElementById('saveStatus');
            saveStatus.textContent = "Saving data...";
            
            fetch('save_data.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(experimentData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    saveStatus.innerHTML = `
                        <p>Data saved successfully!</p>
                        <p>Your completion code: ${data.code}</p>
                    `;
                } else {
                    saveStatus.innerHTML = `
                        <p>Error saving data: ${data.message}</p>
                        <button onclick="downloadBackupData()">Download Backup Data</button>
                    `;
                }
            })
            .catch(error => {
                saveStatus.innerHTML = `
                    <p>Network error: ${error}</p>
                    <button onclick="downloadBackupData()">Download Backup Data</button>
                `;
            });
        }

        function downloadBackupData() {
            const dataStr = JSON.stringify(experimentData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const dataUrl = URL.createObjectURL(dataBlob);
            
            const downloadLink = document.createElement('a');
            downloadLink.href = dataUrl;
            downloadLink.download = `experiment_backup_${experimentData.participant}.json`;
            downloadLink.click();
        }
    </script>
</body>
</html>